<!DOCTYPE html>
<html>
    <head>
        <title>Eye tracking practical</title>
        <link rel='shortcut icon' href='img/favicon.ico' type='image/x-icon'>
        <meta charset='UTF-8'>
        
        <style>
            /* fullscreen elements are initially hidden */
            .fullscreen {
                display: none;
            }
            
            #textbox {
                position: absolute;
                transform: translateY(-50%) translateX(-50%);
                top: 50%;
                left: 50%;
                width: 40%;
                margin: 0px auto;
                
                text-align: center;
                
                border: dashed;
                background-color: white;
            }
            
            #canvas {
                background-color: orange;
            }
        </style>
        
        <script src="js/xlabs.js"></script>
        <script src='js/jquery-3.2.0.min.js'></script>
        <script>
            var isfullscreen = false;
            
            var slides = [];
            
            var imgs = []; // array for preloaded images
            var img_count = 3; // total number of images for image slides
            
            // preload images for image slides
            function preload_images(callback) {
                var toload = img_count;
                
                for (var i = 0; i < img_count; i++) {
                    var img = new Image();
                    imgs.push(img);

                    img.onload = function() {
                        if (--toload === 0) {
                            callback();
                        }
                    };
                    img.src = 'img/img' + i + '.jpg';
                }
            }
            
            function img_slide(imgi) {
                var img = imgs[imgi];
                
                var canvas = $('#canvas');
                
                // work out the size and position of image on canvas
                var img_rat = img.width / img.height;
                var canvas_rat = canvas[0].width / canvas[0].height;
                if (img_rat > canvas_rat) { // image is *relatively* wider than screen
                    var dest_width = canvas[0].width;
                    var dest_height = dest_width / img_rat;
                    var dest_left = 0;
                    var dest_top = (canvas[0].height - dest_height) / 2;
                } else { // image is relatively taller than screen
                    var dest_height = canvas[0].height;
                    var dest_width = dest_height * img_rat;
                    var dest_left = (canvas[0].width - dest_width) / 2;
                    var dest_top = 0;
                }
                
                return function() {
                    // hide text instructions
                    $('#textbox').hide();
                    
                    var ctx = canvas[0].getContext('2d');
                    
                    // clear canvas
                    ctx.clearRect(0, 0, canvas[0].width, canvas[0].height);
                    
                    // draw "slide" image on canvas
                    ctx.drawImage(img, dest_left, dest_top, dest_width, dest_height);
                    
                    // make canvas visible
                    canvas.show();
                };
            }
            
            function text_slide(text) {
                return function() {
                    // hide canvas for displaying images
                    $('#canvas').hide();
                    
                    // change instruction text
                    $('#text')[0].innerHTML = text;
                    
                    // make instruction textbox visible
                    $('#textbox').show();
                };
            }
            
            function slide_prev() {
                if (slidei > 0) {
                    slides[--slidei]();
                }
            }

            function slide_next() {
                if (slidei < slides.length - 1) {
                    slides[++slidei]();
                } else {
                    document.webkitExitFullscreen();
                }
            }
            
            function xlabs_ready() {
                console.log('xlabs ready');
                
                $(window).on('beforeunload', function() {
                    xLabs.setConfig('system.mode', 'off');
                });
                
                xLabs.setConfig('calibration.clear', '1');
                xLabs.setConfig('system.mode', 'learning');
                xLabs.setConfig('browser.canvas.paintLearning', '0');
            }
            
            function xlabs_update() {
                //console.log('xlabs update');
            }
            
            window.onload = function () {
                if (xLabs.extensionVersion() === null) { // no xlabs or not running in chrome
                    document.write(
                        "<h2>Error</h2>" +
                        "This webpage must be viewed in Google Chrome " +
                        "and <a href=\"https://chrome.google.com/webstore/detail/xlabs-headeyegaze-tracker/emeeadaoegehllidjmmokeaahobondco?hl=en\">the xLabs Chrome extension</a> must be installed."
                        );
                
                    return;
                }
                
                xLabs.setup(xlabs_ready, xlabs_update, null, "2bba2616-cf81-4078-85b9-ddd16749abcb");
                return;
                
                // set canvas to fill screen
                var canvas = $('canvas');
                canvas[0].width = screen.width;
                canvas[0].height = screen.height;
                canvas.click(slide_next);
                
                preload_images(function() {
                    console.log('images preloaded');
                    
                    // initialise set of "slides" for experiment
                    slides = [
                        text_slide('Welcome to the University of Sussex eye tracking practical. Click next to continue.'),
                        img_slide(0),
                        img_slide(1),
                        img_slide(2),
                        text_slide('Experiment completed! Thank you for taking part.')
                    ];

                    // actions on entering/exiting fullscreen mode
                    $(document).on('webkitfullscreenchange', function () {
                        isfullscreen = !isfullscreen;
                        if (isfullscreen) {
                            console.log('entering fullscreen mode');
                            
                            slidei = 0; // reset slide counter (start from beginning)
                            slides[0](); // show first slide
                        } else {
                            console.log('exiting fullscreen mode');
                            
                            $('.fullscreen').hide(); // hide all the "fullscreen" elements
                        }
                    });
                });
            };

            function go_fullscreen() {
                $('#div_fs')[0].webkitRequestFullscreen();
            }
        </script>
    </head>
    <body>
        <p id='inittext'>
            Welcome to the University of Sussex eye tracking practical!
            Click <a href='#' onclick='go_fullscreen();'>here</a> to begin the experiment.
        </p>
        
        <div id='div_fs'>
            <div class='fullscreen' id='textbox'>
                <p id='text'></p>

                <div>
                    <a href='#' onclick='slide_prev();'>Previous</a>
                    | <a href='#' onclick='slide_next();'>Next</a>
                </div>
            </div>
            
            <canvas class='fullscreen' id='canvas'></canvas>
        </div>
    </body>
</html>
