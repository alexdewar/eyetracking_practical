<!DOCTYPE html>
<html>
    <head>
        <title>Eye tracking practical</title>
        <link rel='shortcut icon' href='img/favicon.ico' type='image/x-icon'>
        <meta charset='UTF-8'>

        <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
        <style>
            html {
                font-family: 'Open Sans';
            }

            /* fullscreen elements are initially hidden */
            .fullscreen {
                display: none;
            }

            #div_fs {
                background-color: white;
                width: 100%;
                height: 100%;
            }

            #textbox {
                position: absolute;
                transform: translateY(-50%) translateX(-50%);
                top: 50%;
                left: 50%;
                margin: 0px auto;

                width: 60%;
                height: 60%;

                font-size: xx-large;
                text-align: center;

                border-radius: 25px;

                background-color: lightblue;
            }

            #text {
                vertical-align: middle;
                padding: 30px;
            }

            #prev_next {
                vertical-align: bottom;
                padding: 30px;
            }

            #balloons_win {
                position: absolute;
                transform: translateY(-50%) translateX(-50%);
                top: 50%;
                left: 50%;
                margin: 0px auto;
                z-index:2;

                text-align: center;
                font-weight: bold;
                font-family: Monospace;
                font-size: 3.0em;
            }
        </style>

        <!-- jQuery library -->
        <script src='js/jquery-3.2.0.min.js'></script>

        <!-- main script -->
        <script>
            var IMG_COUNT = 3; // total number of images for image slides
            var ANTS_GAME_DURATION = 10; // seconds
            var XLABS_DEVELOPER_TOKEN = "2bba2616-cf81-4078-85b9-ddd16749abcb";

            var isfullscreen = false;

            // different sets of slides for experiment
            var intro_slides = [
                text_slide('<p>Welcome to the eye tracking practical.</p> ' +
                        '<p>During this experiment, we will track the positions of your eyes using the webcam in front of you.</p> ' +
                        '<p>You will first be given some instructions, then you will play a few games to calibrate the eye tracker, then you will perform some data collection.</p> ' +
                        '<p>Click next to continue.</p>'),
                text_slide('<p>For the webcam to get a good image, you should checck that there are no external sources of light. ' +
                        'You should make sure that your hair is not in your face and if you wear glasses but have only a mild prescription, consider removing them (this is not essential).</p> ' +
                        '<p>Most importantly, you should try to keep your head in the same position during both the calibration and testing phases of the experiment.</p>')
            ];
            var balloons_slides = [
                text_slide('<p>You will now play the balloons game...</p>'),
                balloons_start
            ]
            var ants_slides = [
                text_slide('<p>You will first play the ant game, which helps calibrate the system.</p>' +
                        '<p>The aim is to squash ants by clicking on them with the mouse. ' +
                        'After a while you may notice that you can squash ants just by looking at them.</p>' +
                        '<p>Click next to begin.</p>'),
                ants_start
            ];
            var img_slides = [
                text_slide('<p>This is now the testing phase of the experiment.</p>' +
                        '<p>You will be presented with a series of images...</p>'),
                img_slide(0),
                img_slide(1),
                img_slide(2),
            ];

            // initialise set of "slides" for experiment
            /*var slides = intro_slides
             .concat(ants_slides)
             .concat(img_slides)
             .concat([
             text_slide('Experiment completed! Thank you for taking part.')
             ]);*/
            var slides = balloons_slides;
            var imgs = []; // array for preloaded images

            var xlabs_started = false;

            // preload images for image slides
            function preload_images(callback) {
                var toload = IMG_COUNT;

                for (var i = 0; i < IMG_COUNT; i++) {
                    var img = new Image();
                    imgs.push(img);

                    img.onload = function () {
                        if (--toload === 0) {
                            callback();
                        }
                    };
                    img.src = 'img/img' + i + '.jpg';
                }
            }

            function text_slide(text) {
                return function () {
                    $('.fullscreen').hide();

                    // change instruction text
                    $('#text')[0].innerHTML = text;

                    // make instruction textbox visible
                    $('#textbox').show();
                };
            }

            function img_slide(imgi) {
                return function () {
                    var img = imgs[imgi];

                    // work out the size and position of image on canvas
                    var img_rat = img.width / img.height;
                    var canvas_rat = Canvas.element.width / Canvas.element.height;
                    if (img_rat > canvas_rat) { // image is *relatively* wider than screen
                        var dest_width = Canvas.element.width;
                        var dest_height = dest_width / img_rat;
                        var dest_left = 0;
                        var dest_top = (Canvas.element.height - dest_height) / 2;
                    } else { // image is relatively taller than screen
                        var dest_height = Canvas.element.height;
                        var dest_width = dest_height * img_rat;
                        var dest_left = (Canvas.element.width - dest_width) / 2;
                        var dest_top = 0;
                    }

                    $('.fullscreen').hide();

                    // draw "slide" image on canvas
                    Canvas.clear();
                    $('#xLabsAppCanvas').css('background-color', 'black');
                    Canvas.context.drawImage(img, dest_left, dest_top, dest_width, dest_height);
                    set_canvas_click(slide_next);

                    // make canvas visible
                    Canvas.show();
                };
            }

            function ants_start() {
                console.log('starting ants game');

                $('.fullscreen').hide();

                Canvas.clear();
                $('#xLabsAppCanvas').css('background-color', 'white');
                Canvas.show();

                setTimeout(function () {
                    ants.run_game = false;
                    if (isfullscreen) {
                        slide_next();
                    }
                }, ANTS_GAME_DURATION * 1000);

                set_canvas_click(function (e) {
                    ants.onClick(e);
                });

                ants.run_game = true;
                ants.mainLoop();
            }

            function balloons_start() {
                console.log('starting balloons game')

                $('.fullscreen').hide();
                $('#balloons').show();
                Canvas.show();

                Balloons.start();
            }

            function slide_prev() {
                if (slidei > 0) {
                    slides[--slidei]();
                }
            }

            function slide_next() {
                if (slidei < slides.length - 1) {
                    slides[++slidei]();
                } else {
                    document.webkitExitFullscreen();
                }
            }

            function xlabs_start(callback) {
                xlabs_start_callback = callback;
                xLabs.setup(on_xlabs_ready, on_xlabs_update, null, XLABS_DEVELOPER_TOKEN);
            }

            function on_xlabs_ready() {
                console.log('xlabs ready');
                $(window).on('beforeunload', function () {
                    xLabs.setConfig('system.mode', 'off');
                });
                xLabs.setConfig('calibration.clear', '1');
                xLabs.setConfig('system.mode', 'learning');
                xLabs.setConfig('browser.canvas.paintLearning', '0');
            }

            function on_xlabs_update() {
                var mode = xLabs.getConfig('system.mode');
                if (!xlabs_started && mode !== 'off') {
                    xlabs_started = true;
                    console.log('xlabs started');
                    xlabs_start_callback();
                } else if (mode === 'learning') {
                    if (ants.run_game)
                        ants.updateGaze();
                }
            }

            function set_inittext(text) {
                $('#inittext')[0].innerHTML = text;
            }

            function set_canvas_click(f) {
                $('#xLabsAppCanvas').off('click').click(f);
            }

            function on_all_started(error) {
                if (error)
                    throw error;

                set_inittext("Welcome to the University of Sussex eye tracking practical! " +
                        "Click <a href='#' onclick='go_fullscreen();'>here</a> to begin the experiment.");
            }

            window.onload = function () {
                if (xLabs.extensionVersion() === null) { // no xlabs or not running in chrome
                    set_inittext(
                            "<h2>Error</h2>" +
                            "This webpage must be viewed in Google Chrome " +
                            "and <a href='https://chrome.google.com/webstore/detail/xlabs-headeyegaze-tracker/emeeadaoegehllidjmmokeaahobondco?hl=en'>the xLabs Chrome extension</a> must be installed."
                            );
                    return;
                }

                // actions on entering/exiting fullscreen mode
                $(document).on('webkitfullscreenchange', function () {
                    isfullscreen = !isfullscreen;
                    if (isfullscreen) {
                        console.log('entering fullscreen mode');
                        slidei = 0; // reset slide counter (start from beginning)
                        slides[0](); // show first slide
                    } else {
                        console.log('exiting fullscreen mode');
                        $('.fullscreen').hide(); // hide all the "fullscreen" elements
                    }
                });

                ants = new XLabsAnts();
                /*ants.init(function ()
                 {*/
                queue()
                        //.defer(preload_images)
                        .defer(Balloons.setup, slide_next)
                        .defer(xlabs_start)
                        .await(on_all_started);
                //});
            };

            function go_fullscreen() {
                $('#div_fs')[0].webkitRequestFullscreen();
            }
        </script>
    </head>
    <body>
        <p id='inittext'>
            Loading...
        </p>

        <div id='div_fs'>
            <table class='fullscreen' id='textbox'>
                <tr>
                    <td id='text'></td>
                </tr>
                <tr>
                    <td id='prev_next'>
                        <a href='#' onclick='slide_prev();'>Previous</a>
                        | <a href='#' onclick='slide_next();'>Next</a>
                    </td>
                </tr>
            </table>

            <div class='fullscreen' id='balloons'></div>

            <div class='fullscreen' id='balloons_win'>
                <h1>YOU WIN!</h1>
            </div>
        </div>

        <!-- xlabs API -->
        <script src="js/xlabs.js"></script>

        <!-- includes for ants and balloons games -->
        <script src="js/xlabs_utils/d3.v3.min.js"></script>
        <script src="js/xlabs_utils/queue.v1.min.js"></script>
        <script src="js/xlabs_utils/util.js"></script>
        <script src="js/xlabs_utils/state.js"></script>
        <script src="js/xlabs_utils/timer.js"></script>
        <script src="js/xlabs_utils/canvas.js"></script>
        <script src="js/xlabs_utils/errors.js"></script>
        <script src="js/xlabs_utils/gaze.js"></script>
        <script src="js/xlabs_utils/head.js"></script>
        <script src="js/xlabs_utils/graph.js"></script>
        <script src="js/balloons.js"></script>
        <script src="js/ants.js"></script>
    </body>
</html>
